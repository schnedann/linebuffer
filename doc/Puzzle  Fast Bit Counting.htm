<!--?xml version="1.0" encoding="utf-8"?-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><script src="Puzzle%20%20Fast%20Bit%20Counting-Dateien/widgets.js" id="twitter-wjs"></script><script id="bug.surrogate.29">var gapi={plusone:{render:function(){},go:function(){}}};</script><script src="Puzzle%20%20Fast%20Bit%20Counting-Dateien/plusone.js" async="" type="text/javascript"></script><script id="bug.surrogate.20">FB={api:function(){},ui:function(){},Event:{subscribe:function(){}},UIServer:{},XFBML:{parse:function(){}},init:function(){},__noSuchMethod__:function(){}};</script><script src="Puzzle%20%20Fast%20Bit%20Counting-Dateien/all.js" id="facebook-jssdk"></script><script id="bug.surrogate.1">var urchinTracker=function(){},_gaq={push:function(){try {if(arguments[0][0]=='_link')window.location.href=arguments[0][1]}catch(er){}}},_gat={_createTracker:function(){}, _getTracker:function(){return{__noSuchMethod__:function(){},_link:function(o){if(o)location.href=o;},_linkByPost:function(){return true;},_getLinkerUrl:function(o){return o;},_trackEvent:function(){}}}};</script><head>
<meta http-equiv="content-type" content="text/html; charset=windows-1252">
<title>Puzzle: Fast Bit Counting</title>
<link href="https://plus.google.com/100817383473615937733" rel="publisher">
<link rel="shortcut icon" href="http://gurmeet.net/Images/favicon_smile.png" type="image/gif">
<link rel="stylesheet" type="text/css" href="Puzzle%20%20Fast%20Bit%20Counting-Dateien/global.css">
<link rel="stylesheet" type="text/css" href="Puzzle%20%20Fast%20Bit%20Counting-Dateien/puzzles.css">


<!-- BEGIN Google Analytics -->
  <script type="text/javascript">
  // Google Analytics    
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-238283-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
  </script>
<!-- END Google Analytics -->


    <!-- BEGIN Google Plus Follow Button -->
    <link href="https://plus.google.com/112574990334081170886" rel="publisher">
    <!-- END Google Plus Follow Button -->

    <!-- BEGIN ShareThis -->
    <!-- END ShareThis -->
    
<script src="Puzzle%20%20Fast%20Bit%20Counting-Dateien/embed.js" async="" type="text/javascript"></script><style>@-webkit-keyframes poplwhxavxijjhxcjwrrazqysenkyyjdquobazrocm {50% {-webkit-transform:scale(1.2);}100% {-webkit-transform:scale(1);}}@keyframes poplwhxavxijjhxcjwrrazqysenkyyjdquobazrocm {50% {-webkit-transform:scale(1.2);transform:scale(1.2);}100% {-webkit-transform:scale(1);transform:scale(1);}}#lwhxavxijjhxcjwrrazqysenkyyjdquobazrocm{padding:0;margin:0;font:13px Arial,Helvetica;text-transform:none;font-size: 100%;vertical-align:baseline;line-height:normal;color:#fff;border:solid 2px #fff !important;color:#fff !important;display:block !important;height:auto !important;margin:0 !important;opacity:0.9 !important;padding:7px 10px !important;position:fixed !important;visibility:visible !important;width:auto !important;z-index:2147483647 !important;-moz-border-radius:5px !important;border-radius:5px !important;-moz-box-shadow:0px 0px 20px #000 !important;box-shadow:0px 0px 20px #000 !important;}.lwhxavxijjhxcjwrrazqysenkyyjdquobazrocm-blocked{padding:0;margin:0;font:13px Arial,Helvetica;text-transform:none;font-size: 100%;vertical-align:baseline;line-height:normal;color:#fff;color:#777 !important;display:inline !important;text-decoration:line-through !important;}#lwhxavxijjhxcjwrrazqysenkyyjdquobazrocm span{background:transparent !important;padding:0;margin:0;font:13px Arial,Helvetica;text-transform:none;font-size: 100%;vertical-align:baseline;line-height:normal;color:#fff;}#lwhxavxijjhxcjwrrazqysenkyyjdquobazrocm div{padding:0;margin:0;font:13px Arial,Helvetica;text-transform:none;font-size: 100%;vertical-align:baseline;line-height:normal;color:#fff;border:0 !important;margin:0 !important;padding:0 !important;width:auto !important;letter-spacing:normal !important;font:13px Arial,Helvetica !important;text-align:left !important;text-shadow:none !important;text-transform:none !important;word-spacing:normal !important;}#lwhxavxijjhxcjwrrazqysenkyyjdquobazrocm a{padding:0;margin:0;font:13px Arial,Helvetica;text-transform:none;font-size: 100%;vertical-align:baseline;line-height:normal;color:#fff;font-weight:normal !important;background:none !important;text-decoration:underline !important;color:#fff !important;}a#lwhxavxijjhxcjwrrazqysenkyyjdquobazrocm-gear{padding:0;margin:0;font:13px Arial,Helvetica;text-transform:none;font-size: 100%;vertical-align:baseline;line-height:normal;color:#fff;text-decoration:none !important;position:absolute !important;display:none !important;font-size:20px !important;width:20px !important;height:20px !important;line-height:20px !important;text-align:center !important;background-color:rgba(255,255,255,.8) !important;background-image:url(resource://firefox-at-ghostery-dot-com/ghostery/data/images/gear.svg) !important;background-size:16px 16px !important;background-position:center center !important;background-repeat:no-repeat !important;text-decoration:none !important;}a#lwhxavxijjhxcjwrrazqysenkyyjdquobazrocm-gear:hover{-webkit-animation-name:poplwhxavxijjhxcjwrrazqysenkyyjdquobazrocm !important;animation-name:poplwhxavxijjhxcjwrrazqysenkyyjdquobazrocm !important;-webkit-animation-duration:0.3s !important;animation-duration:0.3s !important;}#lwhxavxijjhxcjwrrazqysenkyyjdquobazrocm:hover #lwhxavxijjhxcjwrrazqysenkyyjdquobazrocm-gear{text-decoration:none !important;display:inline-block !important;}@media print{#lwhxavxijjhxcjwrrazqysenkyyjdquobazrocm{display:none !important;}}</style></head>

<body>
<div id="wrap">
<div id="share_follow">

   <!-- BEGIN FaceBook Javascript -->
      <div id="fb-root"></div>
      <script>
        (function(d, s, id) {
          var js, fjs = d.getElementsByTagName(s)[0];
          if (d.getElementById(id)) {return;}
          js = d.createElement(s); js.id = id;
          js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
          fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));
      </script>
    <!-- END FaceBook Javascript -->

    <!-- BEGIN Google Plus Javascript -->
    <script type="text/javascript">
      (function() {
        var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
        po.src = 'https://apis.google.com/js/plusone.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
      })();
    </script>
    <!-- BEGIN Google Plus Javascript -->
  <div style="width:300px; height:25px; overflow:hidden; margin-bottom:10px; margin-top:5px;">

    <!-- BEGIN Facebook Button -->
    <div class="sharing-button-topright-facebook">
    <div>
    <div style="display: block;" class="fb-like" data-send="false" data-layout="button_count" data-width="120" data-show-faces="false" data-font="arial"><iframe style="width: 30px; height: 19px; border: 0px none;" id="mikcvgwkiarzbxiiqtzqsgokgbhfoppwyqstrm"></iframe></div>
    </div>
    </div>
    <!-- END Facebook Button -->
    
    <div class="sharing-button-topright-twitter">
    <div>
    <a style="display: block;" href="https://twitter.com/share" class="twitter-share-button"><iframe style="width: 30px; height: 19px; border: 0px none;" id="aicmjdjazmnpsryfesdwxgnqcleolrpua"></iframe></a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
    </div>
    </div>
    
    <div class="sharing-button-topright-google">
    <div>
    <div style="display: block;" class="g-plusone" data-size="medium"><iframe style="width: 30px; height: 19px; border: 0px none;" id="xejgokvmmachxuhguaaqeanuxxmibbmnrxf"></iframe></div>
    </div>
    </div>
      </div>
  <div style="width:300px; height:25px; overflow:hidden;">

    <div class="sharing-button-topright-email">
    <div>
    <a href="mailto:gurmeet@gmail.com"><img src="Puzzle%20%20Fast%20Bit%20Counting-Dateien/email.gif" valign="middle"> Email Me</a>
    </div>
    </div>
    
    <!-- BEGIN RSS Feed -->
    <div class="sharing-button-topright-rss">
    <div>
<a href="http://feeds.feedburner.com/GurmeetNet" title="Subscribe to my feed" rel="alternate" type="application/rss+xml"><img src="Puzzle%20%20Fast%20Bit%20Counting-Dateien/feed-icon-14x14.png" alt="" style="border:0"></a> <a href="http://feeds.feedburner.com/GurmeetNet" title="Subscribe to my feed" rel="alternate" type="application/rss+xml">Subscribe</a>
    </div>
    </div>
    <!-- END RSS Feed -->
    
    <!-- BEGIN Google Plus Follow Button -->
    <div class="sharing-button-topright-google-follow">
    <div>
    <a href="http://plus.google.com/100817383473615937733?prsrc=3" rel="publisher" style="text-decoration:none;">
    <img src="Puzzle%20%20Fast%20Bit%20Counting-Dateien/gplus-16.png" alt="Google+" style="border:0;width:16px;height:16px;"> Google+</a>
    </div>
    </div>
    <!-- END Google Plus Follow Button -->
      </div>
</div>
<div style="float:left;">

    <div id="breadcrumb_home" onclick="location.href='http://gurmeet.net';">
      <img src="Puzzle%20%20Fast%20Bit%20Counting-Dateien/HomeBrown.png">
      <a href="http://gurmeet.net/">Gurmeet.Net</a>
    </div>
    
    <div id="breadcrumb_arrow">
    <img src="Puzzle%20%20Fast%20Bit%20Counting-Dateien/icon-arrow-right.png">
    </div>
    
        <div id="breadcrumb_section" onclick="location.href='http://gurmeet.net/puzzles/';">
         <img valign="bottom" src="Puzzle%20%20Fast%20Bit%20Counting-Dateien/puzzles2.png" height="25">
 <a href="http://gurmeet.net/puzzles/">Delightful Puzzles</a>
        </div>
        <div id="breadcrumb_date"> 5 Aug 2008 </div> </div>

<div id="top">
<div class="title">Puzzle: Fast Bit Counting</div><div style="clear:both;"></div>
</div>

<div id="main">
<div id="main_content">

    <p>
    Devise a fast algorithm for computing the number of 1-bits in an 
unsigned integer. If the machine supports n-bit integers, can we compute
 the number of 1-bits in O(log n) machine instructions? Can we compute 
the number of 1-bits in O(b) machine instructions where b is the number 
of 1-bits in the integer?
    
    </p><p><b>Source</b>: 
    Commonly asked in  job interviews for Software Engineers. I first heard it in 1996 when I was a graduate student.
    
    </p><p><b>Solution</b>: 
This article presents six solutions to this problem. <a href="http://gurmeet.net/puzzles/fast-bit-counting-routines/bitcount.c">Source code in C</a> is available.

</p><div class="header">1. Iterated Count</div>

<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;color:black;background:white;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #303090; font-weight: bold">int</span> bitcount (<span style="color: #303090; font-weight: bold">unsigned</span> <span style="color: #303090; font-weight: bold">int</span> n) {
   <span style="color: #303090; font-weight: bold">int</span> count <span style="color: #303030">=</span> <span style="color: #0000D0; font-weight: bold">0</span>;
   <span style="color: #008000; font-weight: bold">while</span> (n) {
      count <span style="color: #303030">+=</span> n <span style="color: #303030">&amp;</span>amp; <span style="color: #005080; font-weight: bold">0x1u</span>;
      n <span style="color: #303030">&amp;</span>gt;<span style="color: #303030">&amp;</span>gt;<span style="color: #303030">=</span> <span style="color: #0000D0; font-weight: bold">1</span>;
   }
   <span style="color: #008000; font-weight: bold">return</span> count;
}
</pre></div>

<!--
[sourcecode language="cpp" gutter="true" wraplines="true"]
int bitcount (unsigned int n) {
   int count = 0;
   while (n) {
      count += n &amp; 0x1u;
      n &gt;&gt;= 1;
   }
   return count;
}
[/sourcecode]
-->

Iterated Count  runs  in   time proportional to  the total number  of 
bits.  It simply  loops through all  the bits,  terminating  slightly 
earlier  because  of the  while condition.  Useful if 1's are  sparse 
and among the least significant bits.

<div class="header">2. Sparse Ones</div>

<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;color:black;background:white;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #303090; font-weight: bold">int</span> bitcount (<span style="color: #303090; font-weight: bold">unsigned</span> <span style="color: #303090; font-weight: bold">int</span> n)  {
   <span style="color: #303090; font-weight: bold">int</span> count <span style="color: #303030">=</span> <span style="color: #0000D0; font-weight: bold">0</span> ;
   <span style="color: #008000; font-weight: bold">while</span> (n)  {
      count<span style="color: #303030">++</span> ;
      n <span style="color: #303030">&amp;</span>amp;<span style="color: #303030">=</span> (n <span style="color: #303030">-</span> <span style="color: #0000D0; font-weight: bold">1</span>) ;
   }
   <span style="color: #008000; font-weight: bold">return</span> count ;
}
</pre></div>

<!--
[sourcecode language="cpp" gutter="true" wraplines="true"]
int bitcount (unsigned int n)  {
   int count = 0 ;
   while (n)  {
      count++ ;
      n &amp;= (n - 1) ;
   }
   return count ;
}
[/sourcecode]
-->

Sparse  Ones runs  in  time proportional to the number  of 1 bits.  The 
mystical line n &amp;=  (n - 1) simply sets  the rightmost  1 bit  in n 
 to 0.

<div class="header">3. Dense Ones</div>

<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;color:black;background:white;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #303090; font-weight: bold">int</span> bitcount (<span style="color: #303090; font-weight: bold">unsigned</span> <span style="color: #303090; font-weight: bold">int</span> n)   {
   <span style="color: #303090; font-weight: bold">int</span> count <span style="color: #303030">=</span> <span style="color: #0000D0; font-weight: bold">8</span> <span style="color: #303030">*</span> <span style="color: #008000; font-weight: bold">sizeof</span>(<span style="color: #303090; font-weight: bold">int</span>) ;
   n <span style="color: #303030">^=</span> (<span style="color: #303090; font-weight: bold">unsigned</span> <span style="color: #303090; font-weight: bold">int</span>) <span style="color: #303030">-</span> <span style="color: #0000D0; font-weight: bold">1</span> ;
   <span style="color: #008000; font-weight: bold">while</span> (n)  {
      count<span style="color: #303030">--</span> ;
      n <span style="color: #303030">&amp;</span>amp;<span style="color: #303030">=</span> (n <span style="color: #303030">-</span> <span style="color: #0000D0; font-weight: bold">1</span>) ;
   }
   <span style="color: #008000; font-weight: bold">return</span> count ;
}
</pre></div>

<!--
[sourcecode language="cpp" gutter="true" wraplines="true"]
int bitcount (unsigned int n)   {
   int count = 8 * sizeof(int) ;
   n ^= (unsigned int) - 1 ;
   while (n)  {
      count-- ;
      n &amp;= (n - 1) ;
   }
   return count ;
}
[/sourcecode]
-->

Dense Ones runs  in time proportional  to the number of  0 bits. It is 
the same as Sparse  Ones, except that it first toggles all bits (n  ~= 
-1),  and  continually subtracts  the  number of  1 bits  from 
sizeof(int).

<p>
Sparse Ones and Dense Ones were first described by Peter Wegner in "<a href="http://infolab.stanford.edu/%7Emanku/downloads/cs-papers/p322-wagner.pdf">A Technique for Counting Ones in a Binary Computer</a>", Communications of the ACM, Volume 3 (1960) Number 5, page 322.

</p><div class="header">4a. Precompute-8bit</div>

<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;color:black;background:white;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #008000; font-weight: bold">static</span> <span style="color: #303090; font-weight: bold">int</span> bits_in_char [<span style="color: #0000D0; font-weight: bold">256</span>] ;

<span style="color: #303090; font-weight: bold">int</span> bitcount (<span style="color: #303090; font-weight: bold">unsigned</span> <span style="color: #303090; font-weight: bold">int</span> n)  {
  <span style="color: #808080">// works only for 32-bit ints</span>

  <span style="color: #008000; font-weight: bold">return</span> bits_in_char [n  <span style="color: #303030">&amp;</span>amp; <span style="color: #005080; font-weight: bold">0xffu</span>]
      <span style="color: #303030">+</span>  bits_in_char [(n <span style="color: #303030">&amp;</span>gt;<span style="color: #303030">&amp;</span>gt;  <span style="color: #0000D0; font-weight: bold">8</span> ) <span style="color: #303030">&amp;</span>amp; <span style="color: #005080; font-weight: bold">0xffu</span>]
      <span style="color: #303030">+</span>  bits_in_char [(n <span style="color: #303030">&amp;</span>gt;<span style="color: #303030">&amp;</span>gt; <span style="color: #0000D0; font-weight: bold">16</span>) <span style="color: #303030">&amp;</span>amp; <span style="color: #005080; font-weight: bold">0xffu</span>]
      <span style="color: #303030">+</span>  bits_in_char [(n <span style="color: #303030">&amp;</span>gt;<span style="color: #303030">&amp;</span>gt; <span style="color: #0000D0; font-weight: bold">24</span>) <span style="color: #303030">&amp;</span>amp; <span style="color: #005080; font-weight: bold">0xffu</span>] ;
}
</pre></div>

<!--
[sourcecode language="cpp" gutter="true" wraplines="true"]
static int bits_in_char [256] ;

int bitcount (unsigned int n)  {
  // works only for 32-bit ints

  return bits_in_char [n  &amp; 0xffu]
      +  bits_in_char [(n &gt;&gt;  8 ) &amp; 0xffu]
      +  bits_in_char [(n &gt;&gt; 16) &amp; 0xffu]
      +  bits_in_char [(n &gt;&gt; 24) &amp; 0xffu] ;
}
[/sourcecode]
-->

Precompute_8bit assumes an array bits_in_char  such that bits_in_char[i]
 contains the number of 1  bits in the binary representation  for i.  It
 repeatedly updates count by  masking out the last eight bits  in n, and
 indexing into bits_in_char.

<div class="header">4b. Precompute-16bit</div>

<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;color:black;background:white;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #008000; font-weight: bold">static</span> <span style="color: #303090; font-weight: bold">char</span> bits_in_16bits [<span style="color: #005080; font-weight: bold">0x1u</span> <span style="color: #303030">&amp;</span>lt;<span style="color: #303030">&amp;</span>lt; <span style="color: #0000D0; font-weight: bold">16</span>] ;

<span style="color: #303090; font-weight: bold">int</span> bitcount (<span style="color: #303090; font-weight: bold">unsigned</span> <span style="color: #303090; font-weight: bold">int</span> n)  {
   <span style="color: #808080">// works only for 32-bit ints</span>

   <span style="color: #008000; font-weight: bold">return</span> bits_in_16bits [n         <span style="color: #303030">&amp;</span>amp; <span style="color: #005080; font-weight: bold">0xffffu</span>]
       <span style="color: #303030">+</span>  bits_in_16bits [(n <span style="color: #303030">&amp;</span>gt;<span style="color: #303030">&amp;</span>gt; <span style="color: #0000D0; font-weight: bold">16</span>) <span style="color: #303030">&amp;</span>amp; <span style="color: #005080; font-weight: bold">0xffffu</span>] ;
}
</pre></div>

<!--
[sourcecode language="cpp" gutter="true"]
static char bits_in_16bits [0x1u &lt;&lt; 16] ;

int bitcount (unsigned int n)  {
   // works only for 32-bit ints

   return bits_in_16bits [n         &amp; 0xffffu]
       +  bits_in_16bits [(n &gt;&gt; 16) &amp; 0xffffu] ;
}
[/sourcecode]
-->

Precompute_16bit is  a variant  of Precompute_8bit in  that an array 
bits_in_16bits[]  stores the number of 1 bits in successive 16 bit 
numbers (shorts).

<div class="header">5. Parallel Count</div>

<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;color:black;background:white;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #507090">#define TWO(c)     (0x1u &amp;lt;&amp;lt; (c))</span>
<span style="color: #507090">#define MASK(c) \</span>
<span style="color: #507090">  (((unsigned int)(-1)) / (TWO(TWO(c)) + 1u))</span>
<span style="color: #507090">#define COUNT(x,c) \</span>
<span style="color: #507090">  ((x) &amp;amp; MASK(c)) + (((x) &amp;gt;&amp;gt; (TWO(c))) &amp;amp; MASK(c))</span>

<span style="color: #303090; font-weight: bold">int</span> bitcount (<span style="color: #303090; font-weight: bold">unsigned</span> <span style="color: #303090; font-weight: bold">int</span> n)  {
   n <span style="color: #303030">=</span> COUNT(n, <span style="color: #0000D0; font-weight: bold">0</span>) ;
   n <span style="color: #303030">=</span> COUNT(n, <span style="color: #0000D0; font-weight: bold">1</span>) ;
   n <span style="color: #303030">=</span> COUNT(n, <span style="color: #0000D0; font-weight: bold">2</span>) ;
   n <span style="color: #303030">=</span> COUNT(n, <span style="color: #0000D0; font-weight: bold">3</span>) ;
   n <span style="color: #303030">=</span> COUNT(n, <span style="color: #0000D0; font-weight: bold">4</span>) ;
   <span style="color: #808080">/* n = COUNT(n, 5) ;    for 64-bit integers */</span>
   <span style="color: #008000; font-weight: bold">return</span> n ;
}
</pre></div>

<!--
[sourcecode language="cpp" gutter="true" wraplines="true"]
#define TWO(c)     (0x1u &lt;&lt; (c))
#define MASK(c)   (((unsigned int)(-1)) / (TWO(TWO(c)) + 1u))
#define COUNT(x,c)   ((x) &amp; MASK(c)) + (((x) &gt;&gt; (TWO(c))) &amp; MASK(c))

int bitcount (unsigned int n)  {
   n = COUNT(n, 0) ;
   n = COUNT(n, 1) ;
   n = COUNT(n, 2) ;
   n = COUNT(n, 3) ;
   n = COUNT(n, 4) ;
   /* n = COUNT(n, 5) ;    for 64-bit integers */
   return n ;
}
[/sourcecode]
-->

Parallel  Count  carries  out  bit  counting in a parallel fashion.  
Consider n after the first line has  finished  executing. Imagine 
splitting  n into  pairs of  bits. Each  pair contains the <em>number of ones</em> in those two bit positions  in the  original n.  After  the second line has  finished executing,  each nibble contains the <em>number  of ones</em>
 in those four bits  positions in  the original n.  Continuing this for 
 five iterations,  the 64  bits contain the number  of ones among  these
 sixty-four bit  positions in the original n. That is what we wanted to 
compute.

<div class="header">6. Nifty Parallel Count</div>

<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;color:black;background:white;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #507090">#define MASK_01010101 (((unsigned int)(-1))/3)</span>
<span style="color: #507090">#define MASK_00110011 (((unsigned int)(-1))/5)</span>
<span style="color: #507090">#define MASK_00001111 (((unsigned int)(-1))/17)</span>
 <span style="color: #303090; font-weight: bold">int</span> bitcount (<span style="color: #303090; font-weight: bold">unsigned</span> <span style="color: #303090; font-weight: bold">int</span> n) {
   n <span style="color: #303030">=</span> (n <span style="color: #303030">&amp;</span>amp; MASK_01010101) <span style="color: #303030">+</span> ((n <span style="color: #303030">&amp;</span>gt;<span style="color: #303030">&amp;</span>gt; <span style="color: #0000D0; font-weight: bold">1</span>) <span style="color: #303030">&amp;</span>amp; MASK_01010101) ;
   n <span style="color: #303030">=</span> (n <span style="color: #303030">&amp;</span>amp; MASK_00110011) <span style="color: #303030">+</span> ((n <span style="color: #303030">&amp;</span>gt;<span style="color: #303030">&amp;</span>gt; <span style="color: #0000D0; font-weight: bold">2</span>) <span style="color: #303030">&amp;</span>amp; MASK_00110011) ;
   n <span style="color: #303030">=</span> (n <span style="color: #303030">&amp;</span>amp; MASK_00001111) <span style="color: #303030">+</span> ((n <span style="color: #303030">&amp;</span>gt;<span style="color: #303030">&amp;</span>gt; <span style="color: #0000D0; font-weight: bold">4</span>) <span style="color: #303030">&amp;</span>amp; MASK_00001111) ;
   <span style="color: #008000; font-weight: bold">return</span> n <span style="color: #303030">%</span> <span style="color: #0000D0; font-weight: bold">255</span> ;
}
</pre></div>

<!--
[sourcecode language="cpp" gutter="true" wraplines="true"]
#define MASK_01010101 (((unsigned int)(-1))/3)
#define MASK_00110011 (((unsigned int)(-1))/5)
#define MASK_00001111 (((unsigned int)(-1))/17)
 int bitcount (unsigned int n) {
   n = (n &amp; MASK_01010101) + ((n &gt;&gt; 1) &amp; MASK_01010101) ;
   n = (n &amp; MASK_00110011) + ((n &gt;&gt; 2) &amp; MASK_00110011) ;
   n = (n &amp; MASK_00001111) + ((n &gt;&gt; 4) &amp; MASK_00001111) ;
   return n % 255 ;
}
[/sourcecode]
-->

Nifty Parallel Count  works the same way as Parallel  Count for the 
first three iterations.  At the end of the third line (just before the  
return), each byte of n contains the number of  ones in  those eight  
bit positions in  the original  n. A little thought then explains why 
the remainder modulo 255 works.

<p>According to Don Knuth (The Art of Computer Programming Vol IV, p 11), in the first textbook on programming, <a href="http://www.amazon.com/Preparation-Programs-Electronic-Computer-Institute/dp/0262231182/">The Preparation of Programs for an Electronic Digital Computer</a>
 by Wilkes, Wheeler and Gill (1957, reprinted 1984), pages 191--193 
presented Nifty Parallel Count by D B Gillies and J C P Miller.

</p><div class="header">7. MIT HAKMEM Count</div>

<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;color:black;background:white;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #303090; font-weight: bold">int</span> bitcount(<span style="color: #303090; font-weight: bold">unsigned</span> <span style="color: #303090; font-weight: bold">int</span> n) {
   <span style="color: #808080">/* works for 32-bit numbers only    */</span>
   <span style="color: #808080">/* fix last line for 64-bit numbers */</span>

   <span style="color: #008000; font-weight: bold">register</span> <span style="color: #303090; font-weight: bold">unsigned</span> <span style="color: #303090; font-weight: bold">int</span> tmp;

   tmp <span style="color: #303030">=</span> n <span style="color: #303030">-</span> ((n <span style="color: #303030">&amp;</span>gt;<span style="color: #303030">&amp;</span>gt; <span style="color: #0000D0; font-weight: bold">1</span>) <span style="color: #303030">&amp;</span>amp; <span style="color: #4000E0; font-weight: bold">033333333333</span>)
           <span style="color: #303030">-</span> ((n <span style="color: #303030">&amp;</span>gt;<span style="color: #303030">&amp;</span>gt; <span style="color: #0000D0; font-weight: bold">2</span>) <span style="color: #303030">&amp;</span>amp; <span style="color: #4000E0; font-weight: bold">011111111111</span>);
   <span style="color: #008000; font-weight: bold">return</span> ((tmp <span style="color: #303030">+</span> (tmp <span style="color: #303030">&amp;</span>gt;<span style="color: #303030">&amp;</span>gt; <span style="color: #0000D0; font-weight: bold">3</span>)) <span style="color: #303030">&amp;</span>amp; <span style="color: #4000E0; font-weight: bold">030707070707</span>) <span style="color: #303030">%</span> <span style="color: #0000D0; font-weight: bold">63</span>;
}
</pre></div>

<!--
[sourcecode language="cpp" gutter="true" wraplines="false"]
int bitcount(unsigned int n) {
   /* works for 32-bit numbers only    */
   /* fix last line for 64-bit numbers */

   register unsigned int tmp;

   tmp = n - ((n &gt;&gt; 1) &amp; 033333333333)
           - ((n &gt;&gt; 2) &amp; 011111111111);
   return ((tmp + (tmp &gt;&gt; 3)) &amp; 030707070707) % 63;
}
[/sourcecode]
-->

<p>
MIT   HAKMEM   Count  is   funky. Consider a  3 bit number  as being 
4a+2b+c.   If we shift it  right 1 bit, we have 2a+b.  Subtracting  this
 from the original gives 2a+b+c. If we  right-shift the original 3-bit  
number by two bits,  we get a, and so with another subtraction we have 
a+b+c, which is the number of bits  in the  original number.   How is  
this insight  employed?  The first  assignment  statement in  the  
routine computes  <em>tmp</em>. Consider the octal representation of <em>tmp</em>.  Each digit in the octal representation is simply the number of 1's in the corresponding three bit  positions in <em>n</em>.
   The last return  statement sums these octal digits  to produce the 
final answer.  The  key idea is to add  adjacent pairs  of octal  digits
 together  and then  compute the remainder  modulus  63.    This  is  
accomplished  by  right-shifting <em>tmp</em>  by three  bits, adding  it to  <em>tmp</em>
  itself and ANDing with a suitable mask.  This yields a number in which
 groups of six adjacent bits  (starting from the LSB) contain  the 
number of 1's among  those six  positions  in <em>n</em>.   This  number
 modulo  63 yields the  final answer.  For 64-bit  numbers, we would  
have to add triples of octal  digits and use modulus 1023.   This is 
HACKMEM 169, as  used in  X11  sources.  Source:  MIT  AI Lab  memo, 
late  1970's.

</p><div class="header">8. Builtin Instructions</div>
<p>
GNU compiler allows for </p><pre><font size="+0"><b>int __builtin_popcount (unsigned int x);</b></font></pre>
 which translates into a single CPU instruction if the underlying 
machine architecture supports it. For example, Intel machines have 
POPCNT (SSE4 Instruction set announced in 2006). Many <a href="http://developer.apple.com/documentation/developertools/gcc-4.0.1/gcc/Other-Builtins.html">GCC builtin functions</a> exist.

<div class="header">Performance Measurements</div>

<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;color:black;background:white;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%">                  No          Some        Heavy
            Optimization Optimization Optimization

  Precomp_16 52.94 Mcps   76.22 Mcps   80.58 Mcps
   Precomp_8 29.74 Mcps   49.83 Mcps   51.65 Mcps
    Parallel 19.30 Mcps   36.00 Mcps   38.55 Mcps
         MIT 16.93 Mcps   17.10 Mcps   31.82 Mcps
       Nifty 12.78 Mcps   16.07 Mcps   29.71 Mcps
      Sparse  5.70 Mcps   15.01 Mcps   14.62 Mcps
       Dense  5.30 Mcps   14.11 Mcps   14.56 Mcps
    Iterated  3.60 Mcps    3.84 Mcps    9.24 Mcps

  Mcps = Million counts per second
</pre></div>

<!--
[sourcecode language="text" gutter="true" wraplines="false"]
                  No          Some        Heavy
            Optimization Optimization Optimization

  Precomp_16 52.94 Mcps   76.22 Mcps   80.58 Mcps
   Precomp_8 29.74 Mcps   49.83 Mcps   51.65 Mcps
    Parallel 19.30 Mcps   36.00 Mcps   38.55 Mcps
         MIT 16.93 Mcps   17.10 Mcps   31.82 Mcps
       Nifty 12.78 Mcps   16.07 Mcps   29.71 Mcps
      Sparse  5.70 Mcps   15.01 Mcps   14.62 Mcps
       Dense  5.30 Mcps   14.11 Mcps   14.56 Mcps
    Iterated  3.60 Mcps    3.84 Mcps    9.24 Mcps

  Mcps = Million counts per second
[/sourcecode]
-->

<p>
Which of the  several bit counting routines is  the fastest?  Results of
 speed trials on an i686  are summarized in the table on left.  "No 
Optimization"   was   compiled   with  plain   <em>gcc</em>.    "Some Optimizations"   was    <em>gcc   -O3</em>.   "Heavy   Optimizations" corresponds  to  <em>gcc
   -O3  -mcpu=i686  -march=i686  -fforce-addr -funroll-loops         
-frerun-cse-after-loop        -frerun-loop-opt -malign-functions=4</em>.

</p><p>
Thanks      to     <a href="mailto:seth@systemdetection.com">Seth Robertson</a> who  suggested performing speed trials  by extending <a href="http://infolab.stanford.edu/%7Emanku/bitcount/bitcount.c">bitcount.c</a>.    Seth    also   pointed   me   to MIT_Hackmem          routine.           Thanks         to          <a href="mailto:dennyrolling@hotmail.com">    Denny    Gursky</a>
    who suggested  the idea  of Precompute_11bit.   That would  require 
three sums (11-bit,  11-bit and 10-bit  precomputed counts).  I  then 
tried Precompute_16bit which turned out to be even faster.

</p><p>
If  you  have  niftier  solutions  up  your  sleeves,  please  <a href="mailto:gurmeet@gmail.com">send me an e-mail</a> or write comments below!

</p><div class="header">Further Reading</div>
<p>
</p><ol>
<li><a href="http://www.inwap.com/pdp10/hbaker/hakmem/hakmem.html">HAKMEM</a> (bit counting is memo number 169), MIT AI Lab, Artificial Intelligence Memo No. 239, February 29, 1972.</li>
<li><a href="http://graphics.stanford.edu/%7Eseander/bithacks.html">Bit Twiddling Hacks</a> by Sean Anderson at Stanford University.</li>
<li><a href="http://www-cs-faculty.stanford.edu/%7Eknuth/fasc1a.ps.gz">Bitwise Tricks and Techniques</a> by Don Knuth (The Art of Computer Programming, Part IV).</li>
</ol>

<p>
On 15 March 2009, this article was <a href="http://www.reddit.com/r/programming/comments/84sht/fast_bit_couting_algorithms/">discussed on Reddit</a> — you might learn quite a bit by reading the comments therein.
    
    
    </p><div style="clear:both;"></div>
    </div>
<div style="clear:both;"></div>
</div>
<div id="footer">

    
    <div style="display: block;" id="disqus_thread"><iframe style="width: 100%; border: 1px solid rgb(204, 204, 204); height: 80px; background: none repeat scroll 0% 0% rgb(255, 255, 255);" id="ybckffeguvwxbnhisbwxekabefekezmva"></iframe></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'gurmeetnet'; // required: replace example with your forum shortname
    var disqus_identifier = '463 http://gurmeetsingh.wordpress.com/?p=463';  // Hike name
    var disqus_url = 'http://gurmeet.net/puzzles/fast-bit-counting-routines/index.html';  // URL of this page
    var disqus_title = 'Fast Bit Counting';  // Title of this page
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</div>

    <div id="copyright">© Copyright 2008—2013, <a href="http://gurmeet.net/">Gurmeet Manku</a>. All Rights Reserved.</div>
    </div>


<div title="Klicken Sie hier, um das Warnfeld auszublenden" style="right: 20px ! important; top: 15px ! important; background: none repeat scroll 0% 0% rgb(51, 0, 51) ! important; cursor: pointer;" id="lwhxavxijjhxcjwrrazqysenkyyjdquobazrocm"><div style="background: none repeat scroll 0% 0% rgb(51, 0, 51) ! important;"><a style="right: 0px ! important; top: 0px ! important; border-bottom-left-radius: 3px ! important; border-top-right-radius: 3px ! important;" title="Klicken Sie hier, um das Warnfeld zu konfigurieren" id="lwhxavxijjhxcjwrrazqysenkyyjdquobazrocm-gear" href="#"> </a><span class="lwhxavxijjhxcjwrrazqysenkyyjdquobazrocm-blocked">Disqus</span><br><span class="lwhxavxijjhxcjwrrazqysenkyyjdquobazrocm-blocked">Facebook Connect</span><br><span class="lwhxavxijjhxcjwrrazqysenkyyjdquobazrocm-blocked">Google Analytics</span><br><span class="lwhxavxijjhxcjwrrazqysenkyyjdquobazrocm-blocked">Google+ Platform</span><br><span class="lwhxavxijjhxcjwrrazqysenkyyjdquobazrocm-blocked">Twitter Button</span><br></div></div></body></html>